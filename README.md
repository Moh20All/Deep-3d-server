# 3D Model Serving Platform

A secure Express.js application that serves 3D models with JWT-based authentication for teachers, admins, and students. This platform integrates with MadrassaPlay/SkillSnap through shared JWT secrets.

## 🚀 Features

- **JWT Authentication**: Secure cross-platform authentication between MadrassaPlay and this service
- **Role-based Access**: Separate access levels for teachers, admins, and students
- **3D Model Management**: Upload, update, and delete 3D models (GLB format)
- **Shareable Links**: Generate secure, time-limited links for students
- **Interactive 3D Viewer**: Full-featured Three.js viewer with controls
- **MongoDB Storage**: Persistent model metadata and file storage
- **RESTful API**: Complete CRUD operations for model management

## 🏗️ Architecture

### Authentication Flow

1. **Teacher Access**: MadrassaPlay generates JWT with teacher role → 3D Service validates JWT
2. **Admin Access**: Direct login to 3D Service → Admin JWT for model management
3. **Student Access**: Teachers generate shareable links → Students access via temporary tokens

### Database Schema

```javascript
{
  _id: ObjectId,
  name: String,
  description: String,
  filePath: String,        // Path to stored .glb file
  thumbnailPath: String,   // Optional preview image
  uploadedBy: String,      // Admin ID who uploaded
  createdAt: Date,
  updatedAt: Date
}
```

## 📋 Prerequisites

- Node.js (v14 or higher)
- MongoDB (local or cloud instance)
- npm or yarn

## 🛠️ Installation

1. **Clone and install dependencies:**
   ```bash
   npm install
   ```

2. **Set up environment variables:**
   Create a `.env` file with:
   ```env
   PORT=3001
   MONGODB_URI=mongodb://localhost:27017/3d-model-service
   JWT_SHARED_SECRET=your_very_long_and_secure_shared_secret_key_here
   ADMIN_API_KEY=your_admin_api_key_here_change_this_in_production
   ```

3. **Start MongoDB:**
   ```bash
   # Local MongoDB
   mongod
   
   # Or use MongoDB Atlas cloud instance
   ```

4. **Start the server:**
   ```bash
   npm start
   # or for development
   npm run dev
   ```

## 🔌 API Endpoints

### Teacher Routes (JWT Required)
- `GET /api/models` - List all available models
- `GET /api/models/:id` - Get specific model data
- `POST /api/models/:id/share` - Generate shareable link for students

### Admin Routes (API Key Required)
- `GET /admin/info` - Get admin API key information
- `POST /admin/models` - Upload new model (multipart/form-data)
- `PUT /admin/models/:id` - Update model information
- `DELETE /admin/models/:id` - Delete model

### Student Routes (Public with token)
- `GET /view/:id?token=...` - View 3D model in interactive viewer
- `GET /api/view/:id/model?token=...` - Get model file

### Public Routes
- `GET /` - Main platform page
- `GET /status` - Server status

## 🔐 Authentication

### Teacher Authentication
Teachers authenticate through MadrassaPlay, which generates a JWT with:
```javascript
{
  userId: "teacher123",
  role: "teacher"
}
```

Include this token in API requests:
```bash
curl -H "Authorization: Bearer <teacher_jwt_token>" \
     http://localhost:3001/api/models
```

### Admin Authentication
Admins use an API key in the X-API-Key header:
```bash
curl -H "X-API-Key: your_admin_api_key_here" \
     http://localhost:3001/admin/info
```

### Student Access
Students access models via shareable links generated by teachers:
```
http://localhost:3001/view/64f1a2b3c4d5e6f7g8h9i0j1?token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

## 📁 File Structure

```
3d-model-serving-platform/
├── server.js              # Main server file
├── config.js              # Configuration settings
├── package.json           # Dependencies
├── public/
│   ├── index.html         # Main platform page
│   ├── viewer.html        # 3D model viewer
│   ├── styles.css         # Styling
│   └── uploads/           # Uploaded model files
│       └── models/        # GLB model files
└── README.md              # This file
```

## 🎮 Usage Examples

### 1. Admin Uploads a Model
```bash
# Upload model using API key
curl -X POST http://localhost:3001/admin/models \
     -H "X-API-Key: your_admin_api_key_here" \
     -F "name=My 3D Model" \
     -F "description=A sample 3D model" \
     -F "modelFile=@model.glb"
```

### 2. Teacher Gets Model List
```bash
# Get models (replace <teacher_token> with actual token from MadrassaPlay)
curl -H "Authorization: Bearer <teacher_token>" \
     http://localhost:3001/api/models
```

### 3. Teacher Generates Shareable Link
```bash
# Generate shareable link
curl -X POST http://localhost:3001/api/models/64f1a2b3c4d5e6f7g8h9i0j1/share \
     -H "Authorization: Bearer <teacher_token>"
```

### 4. Student Views Model
Open the shareable link in a browser to view the 3D model with interactive controls.

## 🔧 Configuration

### Authentication Keys
- `JWT_SHARED_SECRET`: Must be identical in both MadrassaPlay and this service
- `ADMIN_API_KEY`: API key for admin access to model management endpoints

### File Upload
- Maximum file size: 50MB
- Supported formats: .glb (GLTF Binary)
- Upload path: `public/uploads/models/`

### CORS
Configure `CORS_ORIGIN` in environment variables for cross-origin requests.

## 🚀 Deployment

### Environment Variables for Production
```env
NODE_ENV=production
PORT=3001
MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/3d-model-service
JWT_SHARED_SECRET=your_production_shared_secret_here
JWT_ADMIN_SECRET=your_production_admin_secret_here
ADMIN_USERNAME=your_admin_username
ADMIN_PASSWORD=your_secure_admin_password
```

### Security Considerations
1. Change all default passwords and secrets
2. Use HTTPS in production
3. Implement rate limiting
4. Add input validation and sanitization
5. Use environment variables for sensitive data
6. Implement proper error handling

## 🐛 Troubleshooting

### Common Issues

1. **MongoDB Connection Error**
   - Ensure MongoDB is running
   - Check MONGODB_URI in environment variables

2. **JWT Token Invalid**
   - Verify JWT_SHARED_SECRET matches between services
   - Check token expiration (default: 24 hours)

3. **File Upload Fails**
   - Check file size (max 50MB)
   - Ensure file is .glb format
   - Verify upload directory permissions

4. **3D Model Not Loading**
   - Check model file path in database
   - Verify GLB file is not corrupted
   - Check browser console for Three.js errors

## 📝 License

MIT License - see LICENSE file for details.

## 🤝 Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable
5. Submit a pull request

## 📞 Support

For issues and questions:
- Create an issue in the repository
- Check the troubleshooting section
- Review the API documentation

---

**Note**: This platform is designed to work seamlessly with MadrassaPlay/SkillSnap. Ensure both services share the same JWT secret for proper authentication.